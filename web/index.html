<!doctype html>
<html>
<head>
    <!-- Recommended meta tags -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!-- PyScript CSS -->
    <link rel="stylesheet" href="https://pyscript.net/snapshots/2023.09.1.RC2/core.css">
    <!-- This script tag bootstraps PyScript -->
    <script type="module" src="https://pyscript.net/snapshots/2023.09.1.RC2/core.js"></script>
</head>
<body>

<!--https://developer.mozilla.org/en-US/docs/Web/API/-->
<!--uploaded an image file to process-->
<input type="file" id="file" name="file" accept="image/*" py-change="file_change"/>

<script>
    WebAssembly.instantiateStreaming(fetch('test.wasm'))
        .then(obj => {
                wasm_exports = {
                    fake_img: obj.instance.exports.fake_img,
                    deal_array: obj.instance.exports.deal_array,
                    alloc_memory: obj.instance.exports.alloc_memory,
                    free_memory: obj.instance.exports.free_memory,
                    memory: obj.instance.exports.memory,
                };
            }
        );

</script>

<py-script>
    import sys
    import ctypes
    from pyscript import display, window, document
    from js import wasm_exports, Array, Uint8Array, Int32Array

    display(sys.version)

    # https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer
    def deal_a_buffer(buf):
        display(f"deal a buffer")
        buf_len = buf.byteLength
        display(f"len: {buf_len}")
        array_ptr = wasm_exports.alloc_memory(buf_len)
        display(f"array_ptr: {array_ptr}")
        array_view = Uint8Array.new(wasm_exports.memory.buffer, array_ptr)
        array_view.set(Uint8Array.new(buf))
        display(f"array_view: {array_view}")

    # https://developer.mozilla.org/en-US/docs/Web/API/File
    def file_change(event):
        print(event.target.files.item(0))
        file = event.target.files.item(0)

        display(f"name: {file.name}")
        display(f"size: {file.size}")
        display(f"type: {file.type}")
        display(f"lastModified: {file.lastModified}")
        display(f"lastModifiedDate: {file.lastModifiedDate}")
        display(f"webkitRelativePath: {file.webkitRelativePath}")

        promise = file.arrayBuffer()
        promise.then(lambda buffer: deal_a_buffer(buffer))

    print("hello world")
    display(f"len: {wasm_exports.fake_img()}")

    array = [1.0, 2.0, 3.0, 4.0, 5.0]

    array_ptr = wasm_exports.alloc_memory(len(array) * 8)
    display(f"array_ptr: {array_ptr}")
    array_view = Int32Array.new(wasm_exports.memory.buffer, array_ptr)
    array_view.set(array)

    deal = wasm_exports.deal_array(array_ptr, len(array))
    display(f"deal: {deal}")
</py-script>

</body>
</html>
